<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <title>Ht-markdown</title>
        <link rel="shortcut icon" href="img/favicon16.png">
        <link type="text/css" rel="stylesheet" href="css/bootstrap.css">
        <link rel="stylesheet" href="codemirror-4.7/lib/codemirror.css">
        <script src="js/jquery-1.10.2.min.js"></script>
        <script src="codemirror-4.7/lib/codemirror.js"></script>
        <!-- 言語に応じたjsファイルを読み込む -->
        <script src="codemirror-4.7/mode/javascript/javascript.js"></script>
        <script src="codemirror-4.7/addon/mode/overlay.js"></script>
        <script src="codemirror-4.7/mode/javascript/javascript.js"></script>
        <script src="codemirror-4.7/mode/markdown/markdown.js"></script>
        <script src="codemirror-4.7/mode/gfm/gfm.js"></script>

        <script src="codemirror-4.7/addon/edit/closebrackets.js"></script>
        <script src="marked/lib/marked.js"></script>
        <script type="text/javascript" src="js/shortcut.js"></script>

        <style>
            body{
                background-color: #ccc;
                padding:20px;
            }
            #result{
                background-color: white;
            }

            .title{
                font-size: 1.6em;
                font-family: impact;
            }
            #result{
                overflow: auto;
            }
            .component{
                display:inline-block;
                width:49%;
            }

        </style>
        <script src="/js/google-tracking.js"></script>
    </head>
    <body>
        <button id="save" class="btn btn-primary">save (Ctrl+S)</button>
        <span> * works in chrome at least</span>
        <a href="https://github.com/hitokun-s/ht-markdown" target="_blank" class="pull-right">Source</a>
        <hr>
        <div id="content">
            <div class="component">
                <p class="title">Markdown</p>
                <textarea id="editor" rows="30" cols="50"></textarea>
            </div>
            <div class="component">
                <p class="title">HTML</p>
                <div id="result"></div>
            </div>
        </div>

        <script>

            $("#save").click(function() {
                var blob = new Blob([$("#editor").val()], {"type": "application/x-msdownload"});
                window.URL = window.URL || window.webkitURL;
//                window.location=window.URL.createObjectURL(blob); //Can't set title in this way! 
                $("<a/>").attr({
                    href: window.URL.createObjectURL(blob),
                    download: "title.md" // TODO user can input title
                })[0].click();
            });

            shortcut.add("Ctrl+S", function() {
                $("#save")[0].click();
            });

            marked.setOptions({
                renderer: new marked.Renderer(),
                gfm: true,
                tables: true,
                breaks: false,
                pedantic: false,
                sanitize: true,
                smartLists: true,
                smartypants: false
            });
            
            var editor;

            $(function() {
                
                editor = CodeMirror.fromTextArea($('#editor')[0], {
//                    mode: "javascript",
                    mode: "gfm",
                    lineNumbers: true,
                    indentUnit: 4,
                    autoCloseBrackets: true,
                    autofocus:true
                });

                editor.on("change", function() {
                    editor.save();
                    $("#result").html(marked($('#editor').val()));
                });

                editor.setOption("extraKeys", {
                    // "SmartEnter" function
                    Enter: function(cm) {
                        if(cm.getLine(cm.getCursor().line).replace(/\s/g, "")){
                            // if the line has any content other than space, 
                            // add 2 spaces at the end of the line.
                            cm.replaceSelection("  ");
                        }
                        cm.execCommand("newlineAndIndent");
                    }
                });
                // fit editor area size to window                
                $(".CodeMirror, #result").height($(window).height() - $("#content").offset().top - $(".title").eq(0).height() - 37);
                
                // this seems to be necessary after resizing eitor
                editor.doc.cm.execCommand("newlineAndIndent");
                editor.doc.cm.execCommand("undo");
            });

        </script>
    </body>
</html>